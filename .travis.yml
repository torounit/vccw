services: docker

env:
  global:
    - HOSTNAME: vccw.dev
      MACHINE_NAME: vccw
      IP: 192.168.33.10
      VM_DIR: /vagrant
      DISTRO: ubuntu1604

before_install:
  - docker pull geerlingguy/docker-${DISTRO}-ansible:latest
  - tmpfile=$(mktemp)
  - docker run --detach --add-host "${HOSTNAME}$(echo -e "\t")${MACHINE_NAME}":127.0.0.1 --volume="${PWD}":${VM_DIR}/:rw --privileged geerlingguy/docker-${DISTRO}-ansible:latest "/sbin/init" > "${tmpfile}"
  - CONTAINER_ID=$(cat ${tmpfile})
  - docker inspect $CONTAINER_ID
  - echo "[default]" > hosts
  - echo "localhost" >> hosts
  - ruby -ryaml -rjson -e "conf = {:vccw =>YAML.load(STDIN.read)}; conf[:vccw][:vagrant_dir] = \"${VM_DIR}\"; puts JSON.generate(conf);" < provision/default.yml > test.json
  - cat test.json | jq .

script:
  - docker exec --tty ${CONTAINER_ID} ansible-playbook --version
  - docker exec --tty ${CONTAINER_ID} ls -alF ${VM_DIR}
  - docker exec --tty ${CONTAINER_ID} pwd
  - docker exec --tty ${CONTAINER_ID} env TERM=xterm ansible-playbook ${VM_DIR}/provision/playbook.yml -i ${VM_DIR}/hosts -e "@${VM_DIR}/test.json" --connection=local -vvv
  - ls -al
